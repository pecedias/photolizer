<?php
require_once('../config.php');
require_once('Compress.php');
// Check if image file is a actual image or fake image
if(isset($_POST["base"])){
	$img = $_POST['base64'];
	function getFileSizeInKb($base64string){
		$bytes = strlen(base64_decode($base64string));
		$roughsize = (((int)$bytes) / 1024.0)* 0.67;
		return round($roughsize,2);
	}
	if(getFileSizeInKb($img) >=3071){
		echo "Tamanho maximo é 3MB.";
		die;
	}
	define('UPLOAD_DIR', 'files_input/');
	
	$ext = explode('/',$img);
	$ext = explode(';',$ext[1]);
	$ext = $ext[0];
	$exclude = 'data:image/'.$ext.';base64,';
	$img = str_replace($exclude, '', $img);
	$img = str_replace(' ', '+', $img);
	$data = base64_decode($img);
	$file = UPLOAD_DIR . uniqid() . '.'.$ext;
	$success = file_put_contents($file, $data);
	print $success ? $file : 'Unable to save the file.';
}
if(isset($_POST["submit"])) {
	require_once('../api/load.php');
	function random($length = 10) {
		$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
		$charactersLength = strlen($characters);
		$randomString = '';
		for ($i = 0; $i < $length; $i++) {
			$randomString .= $characters[rand(0, $charactersLength - 1)];
		}
		return $randomString;
	}
	$target_dir = "files_input/";
	$definied_name = random();
	$imagename = $definied_name;
	//echo "New ID:".$definied_name;
	$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
	$extension = pathinfo($_FILES["fileToUpload"]["name"], PATHINFO_EXTENSION);
	$uploadOk = 1;
	$imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
    $check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);
    if($check !== false) {
        //echo "Arquivo é uma imagem - " . $check["mime"] . ".";
        $uploadOk = 1;
    } else {
        echo "O Arquivo não é uma imagem.";
        $uploadOk = 0;
    }
	    // Check if file already exists
	if (file_exists($target_file)) {
	    echo "O Arquivo já existe.";
	    $uploadOk = 0;
	}
	// Check file size
	if ($_FILES["fileToUpload"]["size"] > 3145728) {
	    echo "Desculpe o arquivo é muito grande, o tamanho maximo é 3MB.";
	    $uploadOk = 0;
	}
	// Allow certain file formats
	if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"
	&& $imageFileType != "gif" ) {
	    echo "Desculpe somente extensões JPG, JPEG, PNG & GIF são aceitas.";
	    $uploadOk = 0;
	}
	    // Check if $uploadOk is set to 0 by an error
	if ($uploadOk == 0) {
	    echo "Desculpe, não foi possivel fazer upload.";
	// if everything is ok, try to upload file
	} else {
	    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
	        //echo "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
	        	rename($target_file,$target_dir.$definied_name.'.'.$extension);
			    $file = $target_dir.$definied_name.'.'.$extension;
			    //var_dump($file);
				$new_name_image = 'file_'.$definied_name.'.'.$extension;
				$quality = 60;
				$destination = 'files_input/';
				$image_compress = new Compress($file, $new_name_image, $quality, $destination);
				//echo $image_compress->compress_image();
				//unlink($file);
				//var_dump($image_compress);
				$id = new_id();
				$imagename = $imagename.'.'.$extension;
				$datetime = date("Y-m-d H:i:s");
				$sql = "INSERT INTO image (id_image,image_name) VALUES (".$id.",'".$imagename."')";
				$conn->exec($sql);
				$url = 'https://ads.deskbr.com/api/detection.php?id='.base64_encode($id).'&img='.base64_encode($imagename);
				echo '<script type="text/javascript">
          			  window.location = "'.$url.'"
     				 </script>';
	    } else {
	        echo "Desculpe, houve um erro ao tentar fazer upoad do arquivo.";
	    }
	}
   
}else{

?>
<!DOCTYPE html>
<html lang="pt-br" >
<head>
  <meta charset="UTF-8">
  <title>Upload de Imagem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
      @import url(//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css);
		@import url(https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500);
		@-webkit-keyframes roll {
		0% {
			opacity: 0;
		}
		50% {
			opacity: 0;
			-webkit-transform: translate(-150%, -50%) rotate(-90deg) scale(0.3);
					transform: translate(-150%, -50%) rotate(-90deg) scale(0.3);
			-webkit-box-shadow: none;
					box-shadow: none;
		}
		100% {
			opacity: 1;
			-webkit-transform: translate(-50%, -50%) rotate(0deg) scale(1);
					transform: translate(-50%, -50%) rotate(0deg) scale(1);
			-webkit-box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
					box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
		}
		}
		@keyframes roll {
		0% {
			opacity: 0;
		}
		50% {
			opacity: 0;
			-webkit-transform: translate(-150%, -50%) rotate(-90deg) scale(0.3);
					transform: translate(-150%, -50%) rotate(-90deg) scale(0.3);
			-webkit-box-shadow: none;
					box-shadow: none;
		}
		100% {
			opacity: 1;
			-webkit-transform: translate(-50%, -50%) rotate(0deg) scale(1);
					transform: translate(-50%, -50%) rotate(0deg) scale(1);
			-webkit-box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
					box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
		}
		}
		body {
		background: #222;
		}
		* {
		-webkit-box-sizing: border-box;
				box-sizing: border-box;
		}
		.wrapper {
		-webkit-animation: roll 1.5s;
				animation: roll 1.5s;
		position: fixed;
		left: 50%;
		top: 50%;
		-webkit-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
		padding: 25px;
		background: #0674a3;
		border-radius: 50%;
		-webkit-box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
				box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
		}
		.wrapper:active #img-result {
		margin-top: 2px;
		-webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
				box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
		}
		.wrapper #img-result {
		cursor: pointer;
		margin: 0;
		position: relative;
		background: #0082BA;
		background-size: cover;
		background-position: center;
		display: block;
		width: 150px;
		height: 150px;
		border-radius: 50%;
		-webkit-box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
				box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
		color: rgba(0, 0, 0, 0);
		-webkit-transition: margin 0.3s, background-image 1.5s, -webkit-box-shadow 0.3s;
		transition: margin 0.3s, background-image 1.5s, -webkit-box-shadow 0.3s;
		transition: box-shadow 0.3s, margin 0.3s, background-image 1.5s;
		transition: box-shadow 0.3s, margin 0.3s, background-image 1.5s, -webkit-box-shadow 0.3s;
		}
		.wrapper #img-result.no-image:before {
		font-family: 'FontAwesome';
		content: "\f030";
		position: absolute;
		left: 50%;
		top: 50%;
		color: #fff;
		font-size: 48px;
		opacity: .8;
		-webkit-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
		text-shadow: 0 0px 5px rgba(0, 0, 0, 0.4);
		}
		.wrapper button {
		margin-top: 20px;
		display: block;
		font-family: 'Open Sans Condensed', sans-serif;
		background: #0082BA;
		width: 100%;
		border: none;
		color: #fff;
		padding: 10px;
		letter-spacing: 1.3px;
		font-size: 1.05em;
		border-radius: 5px;
		-webkit-box-shadow: 0 4px 5px rgba(0, 0, 0, 0.3);
				box-shadow: 0 4px 5px rgba(0, 0, 0, 0.3);
		outline: 0;
		-webkit-transition: margin-top 0.3s, padding 0.3s, -webkit-box-shadow 0.3s;
		transition: margin-top 0.3s, padding 0.3s, -webkit-box-shadow 0.3s;
		transition: box-shadow 0.3s, margin-top 0.3s, padding 0.3s;
		transition: box-shadow 0.3s, margin-top 0.3s, padding 0.3s, -webkit-box-shadow 0.3s;
		}
		.wrapper button:active {
		-webkit-box-shadow: none;
				box-shadow: none;
		margin-top: 24px;
		padding: 8px;
		}
		.show-button {
		background: #264974;
		border: none;
		color: #fff;
		padding: 10px 20px;
		float: right;
		display: none;
		}
		.upload-result {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: #fff;
		overflow-y: auto;
		}
		.upload-result__content {
		word-break: break-all;
		font-family: 'Source Code Pro';
		overflow-wrap: break-word;
		}
		.playme {
		align:center;
		background: #007fed;
		text-transform: uppercase;
		font-weight: 300;
		border: none;
		color: white;
		padding: 10px 15px;
		display: inline-block;
		font-size: 14px;
		margin: 0;
		}

    </style>
</head>
<body translate="no" >
  <div class="wrapper">
  <button class="no-image" id="img-result">Upload Image</button>
  </div>
	<form action="#" method="post" enctype="multipart/form-data">
		<input name="base64" type="hidden" id="base64">
		<center><button type="submit" name="base" class="playme">ENVIAR IMAGEM</button></center>
	</form>
    <script >
      (function () {
			var uploader = document.createElement('input'),
				image = document.getElementById('img-result');
				
			uploader.type = 'file';
			uploader.accept = 'image/*';

			image.onclick = function() {
				uploader.click();
				
			}
			uploader.onchange = function() {
				var reader = new FileReader();
				console.log(reader);
				reader.onload = function(evt) {
				image.classList.remove('no-image');
				image.style.backgroundImage = 'url(' + evt.target.result + ')';
				var request = {
					images: [{
					data: evt.target.result
					}]
				};
				document.getElementById("base64").value = evt.target.result;
				//window.location('https://ads.deskbr.com/upload?d='+evt.target.result);
				//document.getElementById("fileToUpload").value = uploader;
				document.querySelector('.show-button').style.display = 'block';
				document.querySelector('.upload-result__content').innerHTML = JSON.stringify(request, null, '  ');
				}
				reader.readAsDataURL(uploader.files[0]);
			}
			
			document.querySelector('.hide-button').onclick = function () {
				document.querySelector('.upload-result').style.display = 'none';
			};
			
			document.querySelector('.show-button').onclick = function () {
				document.querySelector('.upload-result').style.display = 'block';
			};
			})();
	</script>
	
</body>
</html>
<?php } ?>